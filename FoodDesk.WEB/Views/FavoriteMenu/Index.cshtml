@{
    ViewData["Title"] = "Favorite Menu Page";
    var products = Model as List<FoodDesk.Domain.Entities.Product>;
}

<div class="content-body">
    <div class="container">
        <div class="d-flex align-items-center justify-content-between mb-4">
            <div class="input-group search-area2 style-1">
                <span class="input-group-text p-0">
                    <a href="javascript:void(0)">
                        <svg class="me-1" width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M27.414 24.586L22.337 19.509C23.386 17.928 24 16.035 24 14C24 8.486 19.514 4 14 4C8.486 4 4 8.486 4 14C4 19.514 8.486 24 14 24C16.035 24 17.928 23.386 19.509 22.337L24.586 27.414C25.366 28.195 26.634 28.195 27.414 27.414C28.195 26.633 28.195 25.367 27.414 24.586ZM7 14C7 10.14 10.14 7 14 7C17.86 7 21 10.14 21 14C21 17.86 17.86 21 14 21C10.14 21 7 17.86 7 14Z" fill="#FC8019" />
                        </svg>
                    </a>
                </span>
                <input type="text" class="form-control p-0" placeholder="What do you want eat today...">
            </div>
            <ul class="grid-tab nav nav-pills" id="list-tab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pills-grid-tab" data-bs-toggle="pill" data-bs-target="#pills-grid" type="button" role="tab" aria-controls="pills-grid" aria-selected="false">
                        <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4H6.66667C5.95942 4 5.28115 4.28095 4.78105 4.78105C4.28095 5.28115 4 5.95942 4 6.66667V12C4 12.7072 4.28095 13.3855 4.78105 13.8856C5.28115 14.3857 5.95942 14.6667 6.66667 14.6667H12C12.7072 14.6667 13.3855 14.3857 13.8856 13.8856C14.3857 13.3855 14.6667 12.7072 14.6667 12V6.66667C14.6667 5.95942 14.3857 5.28115 13.8856 4.78105C13.3855 4.28095 12.7072 4 12 4ZM6.66667 12V6.66667H12V12H6.66667ZM25.3333 4H20C19.2928 4 18.6145 4.28095 18.1144 4.78105C17.6143 5.28115 17.3333 5.95942 17.3333 6.66667V12C17.3333 12.7072 17.6143 13.3855 18.1144 13.8856C18.6145 14.3857 19.2928 14.6667 20 14.6667H25.3333C26.0406 14.6667 26.7189 14.3857 27.219 13.8856C27.719 13.3855 28 12.7072 28 12V6.66667C28 5.95942 27.719 5.28115 27.219 4.78105C26.7189 4.28095 26.0406 4 25.3333 4ZM20 12V6.66667H25.3333V12H20ZM12 17.3333H6.66667C5.95942 17.3333 5.28115 17.6143 4.78105 18.1144C4.28095 18.6145 4 19.2928 4 20V25.3333C4 26.0406 4.28095 26.7189 4.78105 27.219C5.28115 27.719 5.95942 28 6.66667 28H12C12.7072 28 13.3855 27.719 13.8856 27.219C14.3857 26.7189 14.6667 26.0406 14.6667 25.3333V20C14.6667 19.2928 14.3857 18.6145 13.8856 18.1144C13.3855 17.6143 12.7072 17.3333 12 17.3333ZM6.66667 25.3333V20H12V25.3333H6.66667ZM25.3333 17.3333H20C19.2928 17.3333 18.6145 17.6143 18.1144 18.1144C17.6143 18.6145 17.3333 19.2928 17.3333 20V25.3333C17.3333 26.0406 17.6143 26.7189 18.1144 27.219C18.6145 27.719 19.2928 28 20 28H25.3333C26.0406 28 26.7189 27.719 27.219 27.219C27.719 26.7189 28 26.0406 28 25.3333V20C28 19.2928 27.719 18.6145 27.219 18.1144C26.7189 17.6143 26.0406 17.3333 25.3333 17.3333ZM20 25.3333V20H25.3333V25.3333H20Z" fill="#FC8019" />
                        </svg>
                    </button>
                </li>
            </ul>
        </div>

        <div class="tab-content" id="pills-tabContent">
            <div class="tab-pane fade" id="pills-list" role="tabpanel" aria-labelledby="pills-list-tab">
                <div class="card h-auto">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-list i-table style-1 mb-4 border-0" id="guestTable-all3">
                                <thead>
                                    <tr>
                                        <th class="bg-none">
                                            <div class="form-check style-3">
                                                <input class="form-check-input" type="checkbox" value="" id="checkAll">
                                            </div>
                                        </th>
                                        <th>Menu</th>
                                        <th>Date</th>
                                        <th>Address</th>
                                        <th>Total</th>
                                        <th>Status</th>
                                        <th class="bg-none"></th>
                                        <th class="bg-none"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var product in products)
                                    {
                                        <tr>
                                            <td>
                                                <div class="form-check style-3">
                                                    <input class="form-check-input" type="checkbox" value="">
                                                </div>
                                            </td>
                                            <td>
                                                <div class="media-bx d-flex py-3 align-items-center">
                                                    <img class="me-3 rounded-circle" src="@Url.Content($"{product.ImageUrl}")" alt="@product.Name">
                                                    <div>
                                                        <h5 class="mb-0">@product.Name</h5>
                                                        <p class="mb-0">1x </p>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <p class="mb-0">@DateTime.Now.ToString("MMMM d, yyyy, hh:mm tt")</p>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <svg class="me-2" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <path d="M20.4604 9.63C20.32 8.16891 19.8036 6.76908 18.9616 5.56681C18.1195 4.36455 16.9805 3.40083 15.6554 2.76949C14.3303 2.13815 12.8642 1.86072 11.4001 1.9642C9.93592 2.06768 8.5235 2.54856 7.30037 3.36C6.24957 4.06264 5.36742 4.98929 4.71731 6.07339C4.0672 7.15748 3.66526 8.3721 3.54037 9.63C3.41785 10.8797 3.57504 12.1409 4.00054 13.3223C4.42604 14.5036 5.10917 15.5755 6.00037 16.46L11.3004 21.77C11.3933 21.8637 11.5039 21.9381 11.6258 21.9889C11.7477 22.0397 11.8784 22.0658 12.0104 22.0658C12.1424 22.0658 12.2731 22.0397 12.3949 21.9889C12.5168 21.9381 12.6274 21.8637 12.7204 21.77L18.0004 16.46C18.8916 15.5755 19.5747 14.5036 20.0002 13.3223C20.4257 12.1409 20.5829 10.8797 20.4604 9.63ZM16.6004 15.05L12.0004 19.65L7.40037 15.05C6.72246 14.372 6.20317 13.5523 5.87984 12.6498C5.5565 11.7472 5.43715 10.7842 5.53037 9.83C5.62419 8.8611 5.93213 7.92516 6.43194 7.08984C6.93175 6.25452 7.61093 5.5407 8.42037 5C9.48131 4.29523 10.7267 3.91929 12.0004 3.91929C13.2741 3.91929 14.5194 4.29523 15.5804 5C16.3874 5.53861 17.065 6.24928 17.5647 7.08093C18.0644 7.91259 18.3737 8.8446 18.4704 9.81C18.5666 10.7674 18.4488 11.7343 18.1254 12.6405C17.8019 13.5468 17.281 14.3698 16.6004 15.05ZM12.0004 6C11.1104 6 10.2403 6.26392 9.5003 6.75838C8.76028 7.25285 8.18351 7.95565 7.84291 8.77792C7.50232 9.60019 7.4132 10.505 7.58684 11.3779C7.76047 12.2508 8.18905 13.0526 8.81839 13.682C9.44773 14.3113 10.2495 14.7399 11.1225 14.9135C11.9954 15.0872 12.9002 14.998 13.7224 14.6575C14.5447 14.3169 15.2475 13.7401 15.742 13.0001C16.2364 12.26 16.5004 11.39 16.5004 10.5C16.4977 9.30733 16.0228 8.16428 15.1794 7.32093C14.3361 6.47759 13.193 6.00264 12.0004 6ZM12.0004 13C11.5059 13 11.0226 12.8534 10.6114 12.5787C10.2003 12.304 9.87989 11.9135 9.69067 11.4567C9.50145 10.9999 9.45194 10.4972 9.54841 10.0123C9.64487 9.52732 9.88297 9.08186 10.2326 8.73223C10.5822 8.3826 11.0277 8.1445 11.5126 8.04803C11.9976 7.95157 12.5003 8.00108 12.9571 8.1903C13.4139 8.37952 13.8043 8.69995 14.079 9.11107C14.3537 9.52219 14.5004 10.0055 14.5004 10.5C14.5004 11.163 14.237 11.7989 13.7681 12.2678C13.2993 12.7366 12.6634 13 12.0004 13Z" fill="#FC8019" />
                                                    </svg>
                                                    <h5 class="mb-0">Elm Street, 23 Yogyakarta</h5>
                                                </div>
                                                <span>2.97 Km</span>
                                            </td>
                                            <td>
                                                <div>
                                                    <h4 class="text-primary">$@product.Price</h4>
                                                </div>
                                            </td>
                                            <td><span class="badge badge-xl light badge-success">Completed</span></td>
                                            <td>
                                                <div>
                                                    <a href="javascript:void(0);" class="btn btn-outline-primary">Order Again</a>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="dropdown dropstart">
                                                    <a href="javascript:void(0);" class="btn-link" data-bs-toggle="dropdown" aria-expanded="false">
                                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M11 12C11 12.5523 11.4477 13 12 13C12.5523 13 13 12.5523 13 12C13 11.4477 12.5523 11 12 11C11.4477 11 11 11.4477 11 12Z" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                            <path d="M18 12C18 12.5523 18.4477 13 19 13C19.5523 13 20 12.5523 20 12C20 11.4477 19.5523 11 19 11C18.4477 11 18 11.4477 18 12Z" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                            <path d="M4 12C4 12.5523 4.44772 13 5 13C5.55228 13 6 12.5523 6 12C6 11.4477 5.55228 11 5 11C4.44772 11 4 11.4477 4 12Z" stroke="#262626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                                        </svg>
                                                    </a>
                                                    <div class="dropdown-menu">
                                                        <a class="dropdown-item" href="javascript:void(0);">Edit</a>
                                                        <a class="dropdown-item" href="javascript:void(0);">Delete</a>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane fade show active" id="pills-grid" role="tabpanel" aria-labelledby="pills-grid-tab">
                <div id="product-grid-container">
                    @await Html.PartialAsync("_ProductGridPartial", products)
                </div>
                <div class="d-flex align-items-center justify-content-xl-between justify-content-center flex-wrap pagination-bx">
                    <div class="mb-sm-0 mb-3 pagination-title">
                        <p class="mb-0"><span>Showing @(ViewBag.CurrentPage * 6 - 5)-@(ViewBag.CurrentPage * 6 > ViewBag.TotalPages * 6 ? ViewBag.TotalPages * 6 : ViewBag.CurrentPage * 6)</span> from <span>@ViewBag.TotalPages * 6</span> data</p>
                    </div>
                    <nav>
                        <ul class="pagination pagination-gutter" id="ajax-pagination">
                            <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link" href="#" data-page="@(ViewBag.CurrentPage - 1)">
                                    <i class="la la-angle-left"></i>
                                </a>
                            </li>
                            @for (int i = 1; i <= ViewBag.TotalPages; i++)
                            {
                                <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                    <a class="page-link" href="#" data-page="@i">@i</a>
                                </li>
                            }
                            <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                                <a class="page-link" href="#" data-page="@(ViewBag.CurrentPage + 1)">
                                    <i class="la la-angle-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            updateCart();

            // Обработчик клика по кнопке добавления в корзину
            $(document).on('click', '.plus.c-pointer', function (e) {
                e.preventDefault();
                console.log('Plus button clicked');
                var productId = $(this).data('product-id');
                console.log('Product ID:', productId);
                
                $.ajax({
                    url: '/Home/AddToCart',
                    type: 'POST',
                    data: { productId: productId },
                    success: function (response) {
                        console.log('Add to cart response:', response);
                        if (response.success) {
                            updateCartDisplay(response.cart);
                        } else {
                            alert(response.message || 'Ошибка при добавлении товара в корзину');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Add to cart error:', error);
                        alert('Ошибка при добавлении товара в корзину');
                    }
                });
            });

            // Обработчик клика по пагинации
            $(document).on('click', '#ajax-pagination .page-link', function (e) {
                e.preventDefault();
                var page = $(this).data('page');
                if (!page || $(this).parent().hasClass('disabled') || $(this).parent().hasClass('active')) return;

                // Показываем индикатор загрузки
                $('#product-grid-container').html('<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>');

                $.get('/FavoriteMenu/ProductGrid', { page: page }, function (data) {
                    $('#product-grid-container').html(data);
                    // Обновляем активную страницу в пагинации
                    $('#ajax-pagination .page-item').removeClass('active');
                    $('#ajax-pagination .page-link[data-page="' + page + '"]').parent().addClass('active');
                    // Обновляем информацию о страницах
                    updatePaginationInfo(page);
                });
            });

            function updatePaginationInfo(page) {
                var totalPages = @ViewBag.TotalPages;
                var itemsPerPage = 6;
                var start = (page - 1) * itemsPerPage + 1;
                var end = Math.min(page * itemsPerPage, totalPages * itemsPerPage);
                $('.pagination-title p span:first').text('Showing ' + start + '-' + end);
            }

            function updateCart() {
                $.ajax({
                    url: '/Home/GetCart',
                    type: 'GET',
                    success: function (response) {
                        if (response.success) {
                            updateCartDisplay(response.cart);
                        } else {
                            alert(response.message || 'Ошибка при загрузке корзины');
                        }
                    },
                    error: function () {
                        alert('Ошибка при загрузке корзины');
                    }
                });
            }

            function updateCartDisplay(cart) {
                var cartItems = $('#cart-items');
                cartItems.empty();

                if (!cart || cart.length === 0) {
                    cartItems.html('<p class="text-center">Корзина пуста</p>');
                    return;
                }

                var total = 1.00;
                $.each(cart, function (index, item) {
                    total += item.price * item.quantity;
                    var html = `
                        <div class="order-check d-flex align-items-center my-3" data-product-id="${item.productId}">
                            <div class="dlab-media">
                                <img src="${item.imageUrl}" alt="${item.name}" style="width: 50px; height: 50px; object-fit: cover;">
                            </div>
                            <div class="dlab-info">
                                <div class="d-flex align-items-center justify-content-between">
                                    <h4 class="dlab-title"><a href="javascript:void(0);">${item.name}</a></h4>
                                    <h4 class="text-primary ms-2">+$${item.price}</h4>
                                </div>
                                <div class="d-flex align-items-center justify-content-between">
                                    <span>x${item.quantity}</span>
                                    <div class="quntity">
                                        <button data-decrease>-</button>
                                        <input data-value type="text" value="${item.quantity}" readonly />
                                        <button data-increase>+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    cartItems.append(html);
                });

                $('#cart-total').text(`$${total.toFixed(2)}`);
            }
        });
    </script>
}